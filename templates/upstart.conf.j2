# vim:filetype=upstart
# {{ ansible_managed }}

description "{{ modcloth_app_name }}"

start on (filesystem or runlevel [2345]) and started docker {{ modcloth_app_upstart_start_condition }}
stop on runlevel [!2345]

respawn
respawn limit 3 30

script
  {% for volume in modcloth_app_docker_volumes -%}
  mkdir -p {{ volume.host }}
  {% endfor %}

  docker stop {{ modcloth_app_name }} >/dev/null 2>&1 || true
  docker rm -f {{ modcloth_app_name }} >/dev/null 2>&1 || true

  docker run --rm \
    -p {{ modcloth_app_docker_port }}:{{ modcloth_app_docker_port }} \
    --hostname "$(hostname)" \
    --env-file /etc/default/{{ modcloth_app_name }} \
    --name {{ modcloth_app_name }} \
    {% for dockeropt in modcloth_app_docker_args -%}
    {{ dockeropt }} \
    {% endfor %}
    {% for volume in modcloth_app_docker_volumes -%}
    -v {{ volume.host }}:{{ volume.container }}:{{ volume.permissions | default("rw") }} \
    {% endfor %}
    {{ modcloth_app_docker_repo }}:{{ modcloth_app_docker_tag }} {{ modcloth_app_docker_command }}
end script
