# vim:filetype=upstart
# {{ ansible_managed }}

description "{{ modcloth_app_name }}"

start on (filesystem or runlevel [2345]) and started docker
stop on runlevel [!2345]

respawn
respawn limit 3 30

script
  DOCKER_SOCK=/var/run/docker.sock

  while [ ! -e $DOCKER_SOCK ] ; do
    inotifywait -t 2 -e create $(dirname $DOCKER_SOCK)
  done

  if docker ps -a | awk '{ print $NF }' | grep -q -E '\b{{ modcloth_app_name }}\b' ; then
    docker stop {{ modcloth_app_name }} || true
    docker rm -f {{ modcloth_app_name }} || true
  fi

  docker run --rm \
    -p {{ modcloth_app_docker_port }}:{{ modcloth_app_docker_port }} \
    --env-file=/etc/default/{{ modcloth_app_name }} \
    --name {{ modcloth_app_name }} \
    {{ modcloth_app_docker_repo }}:{{ modcloth_app_docker_tag }} {{ modcloth_app_docker_command }}
end script
